---
title: "thema07"
author: "keimpe dijkstra"
date: "8-3-2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
---
# Exploratory data analysis

imports
```{r}
library(dplyr)
library(affy)
library(scales)
library(DESeq2)
library(pheatmap)
```


First, we load all our data into r

```{r}
#load in the data using the read.table method
j147 <- read.table("./data/j147.csv", header = T, sep = ",")
cad31 <- read.table("./data/cad-31.txt", header = T, sep = "\t", fill = T)

#create a new column for te gene annotation
cad31$Gene <- strsplit(cad31$Annotation.Divergence, "|", 1)

#filter the gene annotation out of the string
counter <- 1
while( counter < length(cad31$Gene)) {
  
  cad31$Gene[counter] <- cad31$Gene[[counter]][1]
  counter <- counter + 1
}

#drop some unnecesary columns
cad31 <- cad31[c(22, 9:21)]

#merge all the data into one dataframe
data <- merge(j147, cad31)

#delete old dataframes
rm(cad31)
rm(j147)

#replace na's with zero's
data[is.na(data)] <- 0

#rename the columns
names(data) <- c(
                paste0('Gene'),
                paste0('AD.old.j147.', 1:3),
                paste0('AD.old.', 1:3),
                paste0('AD.young.', 1:4),
                paste0('AD.cad31.', 1:3),
                paste0('AD.', 1:3),
                paste0('WT.CAD31.', 1:3),
                paste0('WT.', 1:4) 
                )

#TODO: Check row names just to be sure

#set some indices to help future work
AD.old.j147 <- 2:4
AD.old <- 5:7
AD.young <- 8:11
AD.cad31 <- 12:14
AD <- 15:17
WT.CAD31 <- 18:20
WT <- 21:24



```

## visualizations

basic statistics

```{r}
summary(rowSums(data[AD.old.j147])/3)
summary(rowSums(data[AD.old])/3)
summary(rowSums(data[AD.young])/4)
summary(rowSums(data[AD.cad31])/3)
summary(rowSums(data[AD])/3)
summary(rowSums(data[WT.CAD31])/3)
summary(rowSums(data[WT])/4)
```
The min and first quantile all show similar or very similar results. The wildtype mouse shows the most expression with an almost double maximun than its drugged counterpart.

The young mouse and the mouse on CAD-31 have the least sequences read whereas the mouse with AD and on drugs seem to be upregulated.

This might be explained because of regulation but also the testing can have have a influence on the amount of sequences that are read, therefore we need to normalize the data.


Add 1 to the whole dataframe so it can logscale
```{r}
#set the gene column as row names
row.names(data) <- data$Gene
data[1] <- NULL

data <- data + 1
```

Boxplot
```{r}
myColors <- hue_pal()(7)

boxplot(log2(data),las=2, xlab = "sample mice",
        ylab = "log2 raw gene count", cex.axis=0.5,
        col=rep(myColors,c(3,3,4,3,3,3,4)))

```

Density plot
```{r}
## Plot the log2-transformed data with a 0.1 pseudocount
plotDensity(log2(data + 0.1),
            col=rep(myColors,c(3,3,4,3,3,3,4)),
            lty=c(1:ncol(data)), xlab='Log2(count)',
            main='Expression Distribution')
legend('topright', names(data), lty=c(1:ncol(data)),
       col=rep(myColors,c(3,3,4,3,3,3,4)), cex = 0.3)
abline(v=1.5, lwd=1, col='red', lty=2)
```

Barplot sequence depth
```{r}
barplot(colSums(data)/1000000,    col=rep(myColors,c(3,3,4,3,3,3,4)), 
        xlab = "mouse samples", ylab = "number of reads in millions", cex.names= 0.5, las=2)

abline(h = min(colSums((data)/1000000)), col = "red",
      lty=2, lwd=2)
```

normalization
```{r}

(ddsMat <- DESeqDataSetFromMatrix(countData = data,
                                  colData = data.frame(samples = names(data)),
                                  design = ~ 1))

```

```{r}
rld.dds <- vst(ddsMat)

rld <- assay(rld.dds)



```

```{r}
j.av <- mean(rld[1:10])
c.av <- mean(rld[11:23])

j.bi <- mean(rld[1:10]) +qt(c(0.025, 0.975), length(rld[1:10])-1)*sd(rld[1:10]/sqrt(length(rld[1:10])))
 
c.bi <- mean(rld[11:23]) +qt(c(0.025, 0.975), length(rld[11:23])-1)*sd(rld[11:23]/sqrt(length(rld[11:23])))

rld[1:10] <-rld[1:10]  * c.av/j.av

```

```{r}
sampledist <- dist(t(rld), method = "euclidean", diag = T, upper = T)
sampledistmatrix <- as.matrix(sampledist)
```




heatmap
```{r}
ann <- data.frame(group = factor(c(1,1,1,rep(2,each=7),3,3,3,4,4,4,5,5,5,6,6,6,6),
                                labels = c("AD.J147", "AD.ctrl", "AD.CAD31", "AD.ctrl","WT-CAD31", "WT")),
                  drug = factor(c(rep.int(1,3), rep.int(2,7), rep.int(1,3), rep.int(2,3), rep.int(1,3), rep.int(2,4)), labels = c("on drug", "off drug")),
                  study = factor(c(rep.int(1,10), rep.int(2,13)),
                                 labels = c("study j147", "study cad31")))
                  
row.names(ann) <- names(data)

pheatmap(sampledistmatrix, show_colnames = FALSE,
         annotation_col = ann,
         clustering_distance_rows = sampledist,
         clustering_distance_cols = sampledist,
         main = "Euclidean Sample Distances")                  


```














